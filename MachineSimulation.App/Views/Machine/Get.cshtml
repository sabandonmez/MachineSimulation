@model MachineDetailsDto

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="~/css/get.css" asp-append-version="true" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .input-grubu {

            margin-bottom:1.5rem;
        }

        .input-number {
            border-radius: 12px;
            padding: 0.5rem 1rem;
            width: 10.868rem; /* padding hesabını düşerek genişlik */
            height:2.7rem;
            border:none;
        }

        .veri-gruplari {
            display: flex;
            flex-direction: column;
            align-items:center;
            width:12rem;
        }

        .custom-hr {
            height: 3px !important; /* Çizgi kalınlığı */
            background-color: white !important; /* Koyu gri çizgi rengi */
            margin: 10px 0 !important; /* Üst ve alttan boşluk */
            width: 100% !important; /* Genişlik */
           
            margin-top:1.5rem!important;
            margin-bottom:1.5rem!important;
        }

        .ikinci-baslik{
            color:black;
            margin-bottom:1.2rem;
        }

        .ucuncu-baslik{
            color: black;
           
        }


        .custom-sure-label {
            margin:auto;
        }

        .toplam-sure-design {
            display: flex;
            justify-content: center;
            border: 2px solid gray;
            background-color: white;
            color: #161617 !important;
            transition: background-color 0.3s, color 0.3s;
        }

            .toplam-sure-design:hover {
                background: linear-gradient(to left, #6FCF97, #27AE60);
                color: white !important;
            }

            .graph-card-orange hr{
                color: white!important;
                opacity:2;
            }
    </style>

</head>
<body>
    <div class="mt-3">
        <div class="">
            <h3>@Model.MachineName</h3>

        </div>
        <div class="row">

            <div class="col-md-6">

                <div class="card-div graph-card-blue  mt-4 align-top">
                    
                        <div class="machine-state-card ">
                            <h4 class="machine-state-card-title">
                                Makine Durumu
                            </h4>
                        </div>

                        <div id="machine-state-container" class="machine-state">
                            <img src="~/images/machines/@Model.ImageUrl" />

                            @* Lamb *@

                            <div class="container">
                                <div class="light-up">
                                    <div class="light red" id="red-light"></div>
                                    <div class="light yellow" id="yellow-light"></div>
                                    <div class="light green" id="green-light"></div>
                                </div>

                                <div class="light-down">
                                    <div class="down" id="down"></div>
                                </div>
                                <div class="light-base">
                                    <div class="base" id="base"></div>
                                </div>
                            </div>





                        </div>
                    
                  
                   
                    


                </div>


                <div class="graph-card-pink kalite-card-div h-100 scrollable-quality-datas">
                    <div class="kalite-card">
                        <h4 class="kalite-card-title">
                            Kalite Kriter Verisi
                        </h4>
                    </div>

                    <hr class="line-for-cart" />
                    <div class="row">
                        @foreach (var parameter in Model.Parameters)
                        {
                            <div class="col-md-6 mb-2">

                                <div class="card white-border-card" style="text-align:center;align-content:center">
                                    <div class="card-header" title="@parameter.ParameterName">
                                        <h6>@parameter.ParameterName</h6>
                                    </div>
                                    <div class="card-body">

                                        <h4 class="card-title" data-parameter-name="@parameter.ParameterName" data-parameter-value="@parameter.ParameterValue">0</h4>
                                    </div>

                                </div>
                            </div>

                        }
                    </div>
                </div>




                <div class="log-card-div graph-card-green" onclick="openModal('greenModal')">
                    <h4 class="log-card-title">Log Kayıtları</h4>
                </div>

                <div class="log-card-div graph-card-purple" onclick="openModal('purpleModal')">
                    <h4 class="log-card-title">Parametre Grafikleri</h4>
                </div>


            </div>

            <!-- İkinci içerik alanı -->
            <div class="col-md-6">


                <div class="uretim-card-div graph-card-orange mt-4 align-top scrollable-logs">

                    <div class="uretim-card">
                        <h4 class="uretim-card-title">
                            Üretim-Duruş Drurumu
                        </h4>
                    </div>

                   
                    <div class="custom-hr"><p></p></div>
                    
                    <h5 class="ikinci-baslik">Manuel Üretim</h5>
                    <!-- Üretim bölümü -->
                    <div class="uretim-bolumu">
                        

                        <div class="buton-grubu">
                            <button id="uretimBaslat" class="btn btn-green">Üretim Başlat</button>
                            <button id="uretimiDurdur" class="btn btn-red">Üretimi Durdur</button>
                        </div>
                        <div class="sure-label-grubu custom-sure-label">
                            <span id="uretimSuresiLabel" class="süre-label"><span id="uretimSuresi">0</span></span>
                        </div>
                    </div>
                    <hr />


                    <h5 class="ikinci-baslik">Otomatik Üretim</h5>
                    <!-- Otomatik Üretim bölümü -->

                    <div class="uretim-bolumu">
                        <div class="buton-grubu">
                            <button id="uretimBaslat" class="btn btn-green">Üretim Başlat</button>
                            <button id="uretimiDurdur" class="btn btn-red">Üretimi Durdur</button>
                        </div>
                        <div class="veri-gruplari">
                            <div class="veri-grubu-giris">
                                <h6 class="ucuncu-baslik">Üretim Süresi Giriniz:</h6>
                                <div class="input-grubu">
                                    <input type="number" id="veriGirisi" placeholder="Veri girin" class="input-number">
                                </div>
                            </div>
                           
                            <div class="sure-label-grubu">
                                <span id="uretimSuresiLabel" class="süre-label"><span id="uretimSuresi">0</span></span>
                            </div>
                        </div>
                    </div>


                   



                    <div class="custom-hr"><p></p></div>
                    


                    <h5 class="ikinci-baslik">Hazırlık Duruş Durumu</h5>
                    <!-- Hazırlık bölümü -->
                    <div class="hazirlik-bolumu">

                        <div class="buton-grubu">
                            <button id="hazirlikBaslat" class="btn btn-green">Hazırlık Başlat</button>
                            <button id="hazirlikBitir" class="btn btn-red">Hazırlık Bitir</button>
                        </div>
                        <div class="sure-label-grubu custom-sure-label">
                            <span id="hazirlikSuresiLabel" class="süre-label"><span id="sure">0</span></span>
                        </div>
                    </div>

                    <hr />


                    <h5 class="ikinci-baslik">Belirli Duruş Durumu</h5>
                    <!-- Hazırlık bölümü -->
                    <div class="hazirlik-bolumu">

                        <div class="buton-grubu">
                            <button id="hazirlikBaslat" class="btn btn-green">Duruş Başlat</button>
                            <button id="hazirlikBitir" class="btn btn-red">Duruş Bitir</button>
                        </div>
                        <div class="veri-gruplari">
                            <div class="veri-grubu-giris">
                            <h6 class="ucuncu-baslik">Duruş Sebebi Seçiniz:</h6>
                            <div class="input-grubu">
                                <select id="" class="form-select input-number">
                                    <option></option>
                                    <option>Bakım Arızası</option>
                                    <option>Planlı Duruş</option>
                                    <option>Elektrik Arızası</option>
                                </select>
                            </div>
                            </div>
                            <div class="sure-label-grubu">
                                <span id="uretimSuresiLabel" class="süre-label"><span id="uretimSuresi">0</span></span>
                            </div>
                        </div>
                    </div>

                    
                    <div class="custom-hr"><p></p></div>


                    <!-- Toplam süre -->
                    <div class="log-card-div toplam-sure-design" onclick="openModal('sureModal')">
                        <h5 class="log-card-title">Süre Raporu</h5>
                    </div>

                </div>

            

                <!-- Modals -->
                <div id="greenModal" class="modal">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <h2>Log Kayıtları</h2>
                        <partial name="_OperationLogs" model="Model.OperationLogs" />
                    </div>
                </div>

                <div id="purpleModal" class="modal">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <h2>Parametre Grafikleri</h2>
                        <div id="graphs-container" class="graphs-property">
                            <!-- JavaScript ile dinamik olarak grafik kartları buraya eklenecek -->
                        </div>
                    </div>
                </div>

                @* Toplam Süre Modal *@
                <div id="sureModal" class="modal">
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <h2>Süre Raporu</h2>
                        <div class="d-flex flex-column align-items-center">
                            <span id="toplamSureLabel" class="sure-label mb-1">Toplam Üretim Süresi: <span id="toplamSure">0</span></span>
                        </div>

                    </div>
                </div>


            </div>



        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.7.12/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    
    @* For Models *@
    <script>
        function openModal(modalId) {
            var modal = document.getElementById(modalId);
            modal.style.display = "block";

            var span = modal.getElementsByClassName("close")[0];
            span.onclick = function () {
                modal.style.display = "none";
            }
        }

        // Kullanıcı pencere dışına tıkladığında pencereyi kapat
        window.onclick = function (event) {
            var modals = document.getElementsByClassName('modal');
            for (var i = 0; i < modals.length; i++) {
                if (event.target == modals[i]) {
                    modals[i].style.display = "none";
                }
            }
        }

    </script>

    @* For Lamb *@
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const redLight = document.getElementById('red-light');
            const yellowLight = document.getElementById('yellow-light');
            const greenLight = document.getElementById('green-light');

            let currentLight = 0; // Şu anki ışık durumunu belirten değişken

            // Işık durumunu güncelleyip uygun ışığı yakan fonksiyon
            function updateLights() {
                clearLights();
                switch (currentLight) {
                    case 0:
                        redLight.style.opacity = 2;
                        break;
                    case 1:
                        yellowLight.style.opacity = 2;
                        break;
                    case 2:
                        greenLight.style.opacity =2;
                        break;
                }
                currentLight = (currentLight + 1) % 3; // Sonraki ışığa geç
            }

            // Tüm ışıkları kapatma fonksiyonu
            function clearLights() {
                redLight.style.opacity = 0.5;
                yellowLight.style.opacity = 0.5;
                greenLight.style.opacity = 0.5;
            }

            // Her 3 saniyede bir ışıkları güncelle
            setInterval(updateLights, 3000);
        });


    </script>



    <script>
        function getMachineIdFromUrl() {
            var currentUrl = window.location.pathname; // mevcut sayfanın URL yolunu alır
            var urlSegments = currentUrl.split('/'); // URL yolunu '/' karakterine göre bölerek diziye dönüştürür
            return urlSegments.pop(); // dizinin son elemanını alır (bu durumda machineId olmalıdır)
        }



        $(document).ready(function () {
            var machineId = getMachineIdFromUrl();
            $('#hazirlikBaslat').click(function () {
                $.ajax({
                    url: '@Url.Action("StartPreparation", "Modbus")',
                    type: 'POST',
                    data: { machineId: machineId, operationName: 'Hazırlık Başlat' },
                    success: function (response) {
                        if (response.success) {
                            console.log('Hazırlık başlatıldı.');
                        }
                    }
                });
            });

            $('#hazirlikBitir').click(function () {
                var machineId = getMachineIdFromUrl();
                $.ajax({
                    url: '@Url.Action("StopPreparation", "Modbus")',
                    type: 'POST',
                    data: { machineId: machineId, operationName: 'Hazırlık Bitir' },
                    success: function (response) {
                        if (response.success) {
                            console.log('Hazırlık durduruldu.');
                        }
                    }
                });
            });


            $('#uretimBaslat').click(function () {
                var machineId = getMachineIdFromUrl();
                $.ajax({
                    url: '@Url.Action("StartProduction", "Modbus")',
                    type: 'POST',
                    data: { machineId: machineId, operationName: 'Üretim Başlat' },
                    success: function (response) {
                        if (response.success) {
                            console.log('Üretim başlatıldı.');
                        }
                    }
                });
            });

            $('#uretimiDurdur').click(function () {
                var machineId = getMachineIdFromUrl();
                $.ajax({
                    url: '@Url.Action("StopProduction", "Modbus")',
                    type: 'POST',
                    data: { machineId: machineId, operationName: 'Üretim Bitir' },
                    success: function (response) {
                        if (response.success) {
                            console.log('Üretim durduruldu.');
                        }
                    }
                });
            });
        });
    </script>
    <script>
        var graphsPerPage = 1; // Her sayfada görüntülenecek grafik sayısı
        var currentPage = 1; // Başlangıçta görüntülenecek sayfa
        var parametersData = {}; // Parametre verileri burada saklanacak
        var totalPages = 0; // Toplam sayfa sayısı, hesaplanacak
        $(document).ready(function () {

            

            function changePage(delta) {
                currentPage += delta;
                // Sayfa sınırlarını kontrol et
                currentPage = Math.max(1, Math.min(currentPage, totalPages));
                createCharts(currentPage);
            }

            function createCharts() {
                var graphsContainer = $('#graphs-container');
                graphsContainer.empty(); // Mevcut grafikleri temizle

                var parameterNames = Object.keys(parametersData);

                // Renk paleti
                var colors = [
                    'rgba(255, 99, 132, 1)',  // Kırmızı
                    'rgba(54, 162, 235, 1)',  // Mavi
                    'rgba(255, 206, 86, 1)',   // Sarı
                    'rgba(75, 192, 192, 1)',   // Turkuaz
                    'rgba(153, 102, 255, 1)',  // Mor
                    'rgba(255, 159, 64, 1)',   // Turuncu
                    // Diğer renkler eklenebilir
                ];

                var datasets = parameterNames.map(function (parameterName, index) {
                    var values = parametersData[parameterName];
                    // Her parametre için farklı bir renk, renk sayısını aşarsa tekrar başa dön
                    var color = colors[index % colors.length];
                    return {
                        label: parameterName,
                        data: values,
                        backgroundColor: color,
                        borderColor: color.replace('0.5', '1'), // Şeffaflığı kaldırarak sınır rengini belirler
                        borderWidth: 1,
                        fill: false
                    };
                });

                var canvasId = 'combined-graph';
                var graphDiv = $('<div>', {
                    class: 'graph-card',
                    html: $('<canvas>', { id: canvasId })
                });

                graphsContainer.append(graphDiv);

                var ctx = document.getElementById(canvasId).getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({ length: parametersData[parameterNames[0]].length }, (_, i) => 'Ölçüm ' + (i + 1)),
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }


            function getMachineIdFromUrl() {
                var currentUrl = window.location.pathname; // mevcut sayfanın URL yolunu alır
                var urlSegments = currentUrl.split('/'); // URL yolunu '/' karakterine göre bölerek diziye dönüştürür
                // URL'den makine ID'sini (genellikle son segment olarak) çıkarır
                var machineId = urlSegments[urlSegments.length - 1] || urlSegments[urlSegments.length - 2];
                // Son segment boş bir string ise (örneğin, URL '/' ile bitiyorsa), önceki segmenti kullan
                if (machineId === '') {
                    machineId = urlSegments[urlSegments.length - 2];
                }
                return machineId;
            }

            // Veri yükleme işlemi
            // Makine ID'sini URL'den almak için fonksiyon
            function getMachineIdFromUrl() {
                var currentUrl = window.location.pathname; // mevcut sayfanın URL yolunu alır
                var urlSegments = currentUrl.split('/'); // URL yolunu '/' karakterine göre bölerek diziye dönüştürür
                // URL'den makine ID'sini (genellikle son segment olarak) çıkarır
                var machineId = urlSegments[urlSegments.length - 1] || urlSegments[urlSegments.length - 2];
                // Son segment boş bir string ise (örneğin, URL '/' ile bitiyorsa), önceki segmenti kullan
                if (machineId === '') {
                    machineId = urlSegments[urlSegments.length - 2];
                }
                return machineId;
            }

           


            //Grafik Parametreleri Reload yapma:

            function reloadGraphs() {
                var machineId = getMachineIdFromUrl();
                $.ajax({
                    url: 'Machine/GetMachineParameters/' + machineId,
                    type: 'GET',
                    cache: false,
                    success: function (data) {
                        // Mevcut grafik verilerini temizle
                        parametersData = {};
                        data.forEach(function (param) {
                            parametersData[param.parameterName] = param.parameterValue.map(Number);
                        });
                        totalPages = Math.ceil(Object.keys(parametersData).length / graphsPerPage);
                        createCharts(currentPage);
                    }
                });
            }

           
            $(document).ready(function () {
               
                sendStartProductionRequest(3, function () {
                    // sendStartProductionRequest fonksiyonunun tamamlanmasını izle ve 300ms sonra sendModbusWriteStrings fonksiyonunu tetikle
                    setTimeout(function () {
                        sendModbusWriteStrings(function () {
                            // sendModbusWriteStrings fonksiyonunun tamamlanmasını izle
                            // Ardından sendStartProductionRequest fonksiyonunu her 15 saniyede bir çalıştırmak için bir interval başlat
                            setInterval(function () {
                                sendStartProductionRequest(3);
                            }, 15000);

                            // Aynı zamanda, sendModbusWriteStrings fonksiyonunu her 15.51 saniyede bir çalıştırmak için bir interval başlat
                            setInterval(sendModbusWriteStrings, 15510);
                        });
                    }, 300);
                });
            });

            function sendStartProductionRequest(operationId, callback) {
                console.log('Operation ID:', operationId);
                var machineId = getMachineIdFromUrl();
                console.log('Makine ID:', machineId);

                fetch(`/start/${machineId}?operationId=${operationId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        updateParameterDisplay(data.parameters);
                        reloadGraphs();
                        if (callback) callback();
                    })
                    .catch(error => {
                        console.error('Üretimi başlatırken bir hata oluştu:', error);
                    });
            }

            function sendModbusWriteStrings(callback) {
                var machineId = getMachineIdFromUrl();
                console.log('Machine ID:', machineId);

                var parameters = document.querySelectorAll('.card-title[data-parameter-name]');
                var strings = Array.from(parameters).map(function (param) {
                    return param.textContent || param.innerText;
                });
                console.log(strings);

                fetch('/modbus/writestrings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ machineId: machineId, strings: strings })
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Cevap alınamadı');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Makine Değerleri Gönderildi', data);
                        if (callback) callback();
                    })
                    .catch(error => {
                        console.error('Veri Gönderilirken hata oluştu', error);
                    });
            }

            // Parametreleri güncellemek için fonksiyon
            function updateParameterDisplay(parameters) {
                for (const key in parameters) {
                    if (parameters.hasOwnProperty(key)) {
                        const value = parameters[key];
                        const parameterElement = document.querySelector(`.card-body h4[data-parameter-name="${key}"]`);
                        if (parameterElement) {
                            parameterElement.textContent = value;
                        }
                    }
                }
            }



        });




    </script>
    <script>
        $(document).ready(function () {
            var hazirlikTimer, uretimTimer;
            var hazirlikSuresi = 0, uretimSuresi = 0, toplamSure = 0;
            var hazirlikSuresiEklendi = false;
            var uretimSuresiListesi = [];  // Üretim sürelerini saklamak için bir liste

            function getMachineIdFromUrl() {
                var currentUrl = window.location.pathname; // mevcut sayfanın URL yolunu alır
                var urlSegments = currentUrl.split('/'); // URL yolunu '/' karakterine göre bölerek diziye dönüştürür
                return urlSegments.pop(); // dizinin son elemanını alır (bu durumda machineId olmalıdır)
            }


            function updateLogRecords() {
                var machineId = getMachineIdFromUrl();
                $.ajax({
                    url: '/machine/getLogs/' + machineId,
                    type: 'GET',
                    dataType: 'json',
                    success: function (logs) {
                        var operationNames = {
                            1: 'Hazırlık Başlat',
                            2: 'Hazırlık Bitir',
                            3: 'Üretim Başlat',
                            4: 'Üretimi Durdur',
                        };

                        var logsHtml = logs.map(function (log) {
                            var operationName = operationNames[log.operationId] || 'Bilinmeyen İşlem';
                            return '<tr><td>' + operationName + '</td><td>' + new Date(log.timestamp).toLocaleString() + '</td></tr>';
                        }).join('');
                        $('tbody').html(logsHtml);
                    },
                    error: function (xhr, status, error) {
                        console.error('Log kayıtları güncellenirken hata oluştu: ', error);
                    }
                });
            }

            function sendLog(action) {
                $.ajax({
                    url: '/machine/logoperation',
                    type: 'POST',
                    data: JSON.stringify({
                        MachineId: getMachineIdFromUrl(),
                        OperationId: action === 'Hazırlık Başlat' ? 1 : (action === 'Hazırlık Bitir' ? 2 : (action === 'Üretim Başlat' ? 3 : 4)),
                        Timestamp: new Date().toISOString()
                    }),
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    success: function (response) {

                        updateLogRecords();
                    },
                    error: function (xhr, status, error) {
                        console.error(error);
                    }
                });
            }


            $('#hazirlikBaslat').click(function () {
                hazirlikSuresi = 0;
                $(this).prop('disabled', true);
                $('#hazirlikBitir').prop('disabled', false);
                hazirlikTimer = setInterval(function () {
                    hazirlikSuresi++;
                    $('#sure').text(hazirlikSuresi);  // Hazırlık süresini güncelle
                }, 1000);
                sendLog('Hazırlık Başlat');

            });

            $('#hazirlikBitir').click(function () {
                clearInterval(hazirlikTimer);
                $('#hazirlikBaslat').prop('disabled', false);  // Bu butonun tekrar etkinleştirilmesi gerekiyor.
                $(this).prop('disabled', true);
                toplamSure += hazirlikSuresi;
                hazirlikSuresi = 0;
                $('#sure').text(hazirlikSuresi);  // Hazırlık süresini sıfırla
                $('#toplamSure').text(toplamSure + " saniye");
                sendLog('Hazırlık Bitir');

            });
            $('#uretimBaslat').click(function () {
                uretimSuresi = 0;
                $(this).prop('disabled', true);
                $('#uretimiDurdur').prop('disabled', false);
                uretimTimer = setInterval(function () {
                    uretimSuresi++;
                    $('#uretimSuresi').text(uretimSuresi);
                }, 1000);
                sendLog('Üretim Başlat');

            });

            $('#uretimiDurdur').click(function () {
                clearInterval(uretimTimer);
                $('#uretimBaslat').prop('disabled', false);
                $(this).prop('disabled', true);
                uretimSuresiListesi.push(uretimSuresi);  // Üretim süresini listeye ekle
                toplamSure += uretimSuresi;
                uretimSuresi = 0;
                $('#uretimSuresi').text(uretimSuresi);
                $('#toplamSure').text(toplamSure + " saniye");
                $('#uretimSuresiListesi').text('Üretim Süreleri: ' + uretimSuresiListesi.join(', '));  // Listeyi göster
                sendLog('Üretim Bitir');

            });

            // Başlangıçta butonları uygun duruma getir
            $('#hazirlikBitir').prop('disabled', true);
            $('#uretimiDurdur').prop('disabled', true);
        });


    </script>



</body>
</html>